name: Build Check

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

concurrency:
  group: build-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  STABLE_PYTHON_VERSION: "3.11"

jobs:
  build-test:
    name: Test package build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch all tags for proper versioning
        fetch-depth: 0

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.STABLE_PYTHON_VERSION }}

    - name: Install Hatch
      run: uv tool install hatch

    - name: Build package
      run: hatch build

    - name: Verify build artifacts
      run: |
        ls -la dist/
        # Check that both wheel and sdist are created
        if ! ls dist/*.whl 1> /dev/null 2>&1; then
          echo "ERROR: No wheel file found"
          exit 1
        fi
        if ! ls dist/*.tar.gz 1> /dev/null 2>&1; then
          echo "ERROR: No source distribution found"
          exit 1
        fi
        echo "Build artifacts created successfully"

    - name: Test package installation
      run: |
        uv pip install dist/*.whl
        python -c "import castor_etc; print('Successfully imported castor_etc')"

    - name: Upload build artifacts (for debugging)
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/*
        if-no-files-found: error
        retention-days: 7
